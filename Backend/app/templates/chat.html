<!doctype html>
<html lang="ru">
<head>
	<meta charset="UTF-8">
	<title></title>


	<link rel="stylesheet" href="{{url_for('static', filename='css/bootstrap.css')}}">
	<link rel="stylesheet" href="{{url_for('static', filename='css/style.css')}}">
	
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>


	
</head>
<body  style="background-color: #2F3B50;">
	
	<div id="wrapper">
        {% include 'sidebar.html' %}
		<!-- Контентная часть -->
		<div id="page-wrapper" class="bg-color-ddd">
			
			<!-- Заголовок страницы -->
			<div class="row wrapper bg-color-fff border-bottom  page-heading margin-bottom-21">
				<div class="col-sm-12">
					
					<div class="container-fluid">
						<div class="row row-fluid">
							<div id="page-name" class="col-sm-12 centering-y">
								Сообщения
							</div>
						</div>
					</div>
					
				</div>
			</div>
			<!-- /Заголовок страницы -->
	
				
						
			<div class="row">
				<div class="col-xs-12">
					<div class="wrapper wrapper-content">

						<!-- Content -->                    



						
						<div class="row">

							<div class="col-xs-9 chat-massageblock">
								<div class="panel panel-default chat-massage-box">
									
										<div class="panel-heading">
											История сообщений
										</div>
										
										<div class="media panel-body" id="message_box">
										</div>
										
										<div class="panel-footer padding-bottom-21">
											<form id="chat-massage-submitform"  enctype="multipart/form-data"  method="post" action="">
												<textarea name="chat-massage-writepanel" id="message" name="message" class="panel form-control col-xs-12 chat-massage-writepanel" placeholder="Введите сообщение..."></textarea>
												<div class="container-fluid">
													<div class="row-fluid">
														<div class="col-xs-1 text-right padding-right-0 centering-y">
															<span class="file-upload">
																<label>
																	<input type="file" name="file" id="file">
																	<span class="glyphicon glyphicon-paperclip"></span>
																</label>
															</span>
														</div>
														<div class="col-xs-8 centering-y">
															<span id="filename" class="filename">
																<label for="file" class="padding-0 margin-0  font-14">Прикрепить изображение</label>
															</span>
														</div>
														<div class="col-xs-3 text-right padding-right-0 centering-y">
															<button  type="submit" form="chat-massage-submitform" class="btn btn-default">Отправить</button> 
														</div>
														<div class="clear"></div>
													</div>
												</div>
											</form>
										</div>
										
								</div>
							</div>
							
							<div class="panel col-xs-3 chat-userblock padding-0">
								<div class="panel-heading">
									Пользователи
								</div>
								<div class="panel-body">
									<ul>
                                        {% for item in users %}
                                            <li><span class="online"></span><a id="__{{item}}" class="change_chat" href="{{item}}">{{item}}</a></li>
                                        {% endfor %}
										<!-- <li><span class="online"><a href="#">222</a></li>
										<li><span class="online"><a href="#">333</a></li>
										<li><span class="offline"><a href="#">444</a></li>
										<li><span class="offline"><a href="#">UserMan</a></li>
										<li><span class="offline"><a href="#">5555</a></li> -->
									</ul>
								</div>
							</div>
							
						</div>
						


						<!-- / Content -->


					</div>
				</div>
			</div>
				<div class="footer">
					<div class="pull-right">
						
					</div>
					<div class="col-xs-8">
					
					
					</div>
				</div>

        </div>
		<!-- Контентная часть -->
	
	
	
	
	
	
	
<div id="Modal-upload-files" class="modal fade">
<form action="">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
        <h4 class="modal-title">Подтверждение действия</h4>
      </div>
	
	 <div class="modal-body">
		<div class="row">
			<div class="col-xs-12">
				Вы точно хотите изменить данные?
			</div>
		 </div>
	 </div>
	
	<div class="modal-footer">
		<div class="row">
			<div class="col-xs-12">
				<button type="button" class="btn btn-primary" data-dismiss="modal" aria-hidden="true">Отмена</button>
				<input class="btn btn-primary" id="submit" type="submit" name="submit" value="Подтвердить">
			</div>
					
     	</div>
    </div>
  </div>
</div>
</form>	
	
	
	
	
	
	
	
	</div>
	
	
	
	
	
	
	
	


		
		
		
		
	<script src="{{url_for('static', filename='js/bootstrap.js')}}" type="text/javascript"></script>
	<script src="{{url_for('static', filename='js/expromptum.js')}}" type="text/javascript"></script>
	<script src="{{url_for('static', filename='js/jquery.pickmeup.js')}}" type="text/javascript"></script>
	<script src="{{url_for('static', filename='js/jquery.pickmeup.twitter-bootstrap.js')}}" type="text/javascript"></script>
	
		
		<script>
			expromptum();
			
			jQuery(function($){
				$("#tel-number").mask("(999) 999-99-99"); // Маска телефона

				$('body').on('click', '.tel-number', function(){
					$(".tel-number").mask("(999) 999-99-99");
					});
				
				
				$('#vladelec').click(function() {
						$(".yurik-fizik-check").show();
						});
				$('#reklamodatel').click(function() {
						$(".yurik-fizik-check").hide();
					
						});
				
				
				$(document).ready( function() {
					$(".file-upload input[type=file]").change(function(){
						 var filename = $(this).val().replace(/.*\\/, "");
						 $("#filename").html(filename);
					});
				});
				
				
		
				$('.date-select').pickmeup_twitter_bootstrap({
    				format		: 'd-m-Y',
					position	: 'top',
					prev		: '',
					next		: '',
					separator	: ';',
					locale		: {
									days: ["Воскресенье", "Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота"],
									daysShort: ["Вск", "Пнд", "Втр", "Срд", "Чтв", "Птн", "Суб"],
									daysMin: ["Вс", "Пн", "Вт", "Ср", "Чт", "Пт", "Сб"],
									months: ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"],
									monthsShort: ["Янв", "Фев", "Мар", "Апр", "Май", "Июн", "Июл", "Авг", "Сен", "Окт", "Ноя", "Дек"]
									}
					});
				
				
				
				
			});

            function getCookie(cname) {
                var name = cname + "=";
                var ca = document.cookie.split(';');
                for(var i=0; i<ca.length; i++) {
                    var c = ca[i];
                    while (c.charAt(0)==' ') c = c.substring(1);
                    if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
                }
                return "";
            }
            function timeConverter(UNIX_timestamp){
                var offset = new Date().getTimezoneOffset();
                var a = new Date(UNIX_timestamp * 1000 - offset * 60 * 1000);

                var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                var year = a.getFullYear();
                var month = a.getMonth();
                var date = a.getDate();
                var hour = a.getHours();
                var min = a.getMinutes();
                var sec = a.getSeconds();
                sec = sec.toString();
                min = min.toString();
                hour = hour.toString();
                if (hour.length < 2) {
                    hour = "0" + hour;
                }
                if (min.length < 2) {
                    min = "0" + min;
                }
                if (sec.length < 2) {
                    sec = "0" + sec;
                }

                var time = date + '.' + month + '.' + year + ' ' + hour + ':' + min + ':' + sec;
                return time;
            }

            var to = "";
            var need_reload = 0;
            {% if g.user.is_admin() %}
                $('.change_chat').click(function(){ 
                    var id = this.id;
                    to = id.slice(2);
                    need_reload = 1;
                    messages_cnt = 0;
                    ajax_call();
                    return false;
                });  
            {% else %}
                to = "admin";
                $('.change_chat').click(function(){ 
                    return false;
                });  
            {% endif %}

            var messages_cnt = 0;
            var success_chat_get = function(data) {
                if (data.code !== 0) {
                    return;
                }
                if (need_reload == 1) {
                    var div = document.getElementById('message_box');
                    div.innerHTML = '';
                    need_reload = 0;
                }
                var messages = data.data.messages;
                for (i = messages_cnt; i < messages.length; i++) {
                    var div = document.getElementById('message_box');
                    if ("{{g.user.is_admin()}}" == "False" ? messages[i].from == "{{g.user.email}}" : !(messages[i].from == "{{g.user.email}}")) {
                        div.innerHTML = div.innerHTML + "<div class=\"row massage\">\
                                                            <div class=\"float-right text-center col-xs-2 avatar-block\">\
                                                                <div class=\"avatar\" style=\"background-image: url('{{url_for('static', filename='img/anonim.jpg')}}'); \"></div>\
                                                            </div>\
                                                            <div class=\"float-right media-body-xs col-xs-9 alert from-user-massage font-16\">\
                                                                <div class=\"container-fluid\">\
                                                                    <div class=\"row-fluid\">\
                                                                        <div class=\"col-xs-4 centering-y padding-left-0 font-12\">" + timeConverter(messages[i].timestamp) + "</div> \
                                                                        <div class=\"col-xs-8 text-right centering-y padding-right-0 font-14 b nick\"><span class=\"offline\"></span>" + {% if g.user.is_admin() %}to{% else %} "{{g.user.email}}" {% endif %} + "</div>\
                                                                    </div>\
                                                                </div>\
                                                                <div class=\"row padding-top-7\">\
                                                                    <div class=\"col-xs-12 text-massage font-14\">\
                                                                        " + messages[i].message + "\
                                                                    </div>\
                                                                </div>\
                                                            </div>\
                                                        </div>";
                    } else {
                        div.innerHTML = div.innerHTML + "<div class=\"row massage\">\
                                                            <div class=\"col-xs-2 text-center avatar-block\">\
                                                                <div class=\"avatar\" style=\"background-image: url('{{url_for('static', filename='img/supportman.png')}}'); \"></div>\
                                                            </div>\
                                                            <div class=\"media-body-xs col-xs-9 alert from-supportman-massage font-16\">\
                                                                <div class=\"container-fluid\">\
                                                                    <div class=\"row-fluid\">\
                                                                        <div class=\"col-xs-8 centering-y padding-left-0 font-14 b nick\">Техническая поддержка <span class=\"online\"></span></div>\
                                                                        <div class=\"col-xs-4 text-right padding-right-0 centering-y font-12 date-massage\">" + timeConverter(messages[i].timestamp) + "</div>\
                                                                    </div>\
                                                                </div>\
                                                                <div class=\"row padding-top-7\">\
                                                                    <div class=\"col-xs-12 text-massage font-14\">\
                                                                    " + messages[i].message + "\
                                                                    </div>\
                                                                </div>\
                                                            </div>\
                                                        </div>";
                    }

                }
                need_reload = 0;
                if (messages.length < messages_cnt) {
                    messages_cnt = 0;
                } else if (messages.length > messages_cnt) {
                    messages_cnt = messages.length;
                    var elem = document.getElementById('message_box');
                    elem.scrollTop = elem.scrollHeight;
                } else {
                    messages_cnt = messages.length;
                }
            }
			
            var ajax_call = function() {
                $.get( "api/chat/message", { "token" : getCookie("token"), limit: "-1", from: to}, success_chat_get );
            };

            var interval = 1000 * 3;
            ajax_call();
            setInterval(ajax_call, interval);


            $("#chat-massage-submitform").submit(function(e) {

                var url = "/api/chat/message";

                $.ajax({
                       type: "POST",
                       url: url,
                       data: {"token" : getCookie("token"), "to" : to, "message" : $("#chat-massage-submitform").serializeArray()[0].value},
                       success: function(data)
                       {
                            $('#chat-massage-submitform')[0].reset();
                            ajax_call();   
                       },
                       error: function(data)
                       {
                            console.log("ERROR: " + JSON.parse(data.responseText).message);
                            ajax_call();
                       }
                     });

                e.preventDefault(); // avoid to execute the actual submit of the form.
            });

		</script>	
	
	
	
			
	
	
</body>
</html>